
\section{Swap channels}

One of the major issues with direct ``on-chain'' payments in a blockchain network, is that each transaction must be processed by each and every node participating in the network, resulting in high transaction costs.
One strategy to mitigate transaction costs is to defer payments and process them in bulk. In exchange for reduced cost, the beneficiary must be willing to incur higher risk of settlement failure.

\subsection{A simple chequebook}\label{subsec:simple-chequebook}

A very simple smart contract that allows the beneficiary to choose when payments are to be processed, was introduced in \cite{ethersphere2016sw3}.
This \gloss{chequebook} contract is a wallet that can process cheques issued by its owner. The cheques are
analgous to those in the real-world: the issuer signs a cheque specifying a beneficiary, a date and an amount,
gives it to the recipient as a token of promise to pay at a later date. The smart contract plays the
role of the bank. When the recipient wishes to get paid, they ``cash the cheque'' by submitting it to the smart contract. The contract, after validating the signature, date and the amount specified on the cheque, transfers the amount to the beneficiary's account (see figure \ref{fig:swap-chequebook}).
%Analogously to the person taking the cheque to the bank to cash it, anyone can send the digital cheque as part of the data in a transaction to the owner's chequebook account and thus trigger the transfer.

\input{swap-diagram.tex}

Since these digital cheques are files and can therefore be copied, care must be taken that the same cheque cannot be cashed twice. Such ``double cashing'' can be prevented by assigning each cheque given to a particular beneficiary a serial number which the contract will store when the cheque is cashed. The chequebook contract can then rely on the serial number to make sure cheques are cashed in sequential order, thus needing to store only a single serial number per beneficiary.
An alternative strategy to prevent double cashing, when repeated payments are made to the same beneficiary, is that the cheques contain the \emph{cumulative} total amount ever credited to the beneficiary. The total cumulative amount that has been cashed out is stored in the contract for each beneficiary. When a new cheque is submitted, the contract ignores cheques with amount equal to or less than the stored total, but it will transfer the difference if it receives a cheque with a higher total.

This simple trick also makes it possible to cash cheques in bulk because only the current `last cheque' need ever be processed. This achieves the reduction of transaction costs alluded to above.

Incidentally, the cumulative amount stored in the contract represents the total of all outgoing payments that have been honoured and thus the contract also serves as a credit history for the owner.

The amount deposited in the chequebook (\gloss{global balance}) serves as collateral for the cheques. It is pooled over the beneficiaries of all outstanding cheques.
In this simplest form, the chequebook has the same guarantee as real-world cheques: none. Since funds can be freely moved out of the chequebook wallet at any time, solvency at the time of cashing can never be guaranteed: if the chequebook's balance is less than the amount sanctioned by a cheque submitted to it, the cheque will bounce. This is the trade off between transaction costs and risk of settlement failure.

\input{swap-cheques.tex}

\input{swap-waivers.tex}


\subsection{Using the chequebook one half of a payment channel}
The prototypical payment channel consists of a smart contract set up by two parties A and B. The contract has some number of ether locked up in it that A and B have deposited and the contract keeps track of which portion of the locked up ether belongs to each party. The two parties A and B can exchange signed messages that would (if submitted to the channel contract) change the balance of ownership. Many such messages can be sent back and forth and function as payments between the two parties. Crucially, most of these messages do not need to be submitted to the contract at all. Parties may submit a new state to the channel at any time in order to `save the current state on-chain', but only when one party wishes to actually withdraw ether from the channel does the last message indicating the current `state' of the channel - i.e. the balance between A and B - \emph{have} to be submitted.

A chequebook contract implementing a debt waiving procedure like the one outlined in section \ref{subsubsec:waivingdebt} shares a lot of the same features. If user A has deployed such a chequebook and is using it to pay user B, then the cheques act very similarly to the payment messages above. Key differences to a full payment channel are

\begin{enumerate}
    \item Initially payments can only flow in one direction (from A to B) and the balance can never go `below zero` i.e. in A's favour. This is why we refer to this construct as `half' of a payment channel. It is analogous to a payment channel in which the initial deposit was made only by A.
    \item Balances cannot be updated on-chain without a transfer. All collateral in the contract belongs to A; all that B can do is send in cheques to request a payout.
    \item Payout is not guaranteed. 
\end{enumerate}

The fact that payout is not guaranteed is a result of the fact that cheques can bounce (see section \ref{subsec:simple-chequebook}). However it is possible to add a payout guarantee to the cheques on a per-user basis.

\subsubsection{Per-user guarantees}\label{subsubsec:per-user-guarantees}

The chequebook deployed by user A has a balance of ether that acts as collateral for all outstanding cheques A has issued. As such, any user B holding a cheque from A has no guarantee that payout will be possible at any particular time in the future. 

To add a payout guarantee, A would need to make only small modifications to the contract. Explicitly, in order to be able to issue guaranteed cheques to user B, the contract would contain some ether that is locked in the contract and acts as collateral for payments from A to B only. Any cheques held by B are thus guaranteed to be honoured up to this locked amount. Indeed, the only way A can withdraw the locked amount would involve a payout request by A followed by a grace period during which B is still able to submit any outstanding cheques.

With this mechanism in place, the chequebook is now almost equivalent to a full payment channel (albeit one in which the entire initial deposit was made by A).

Note: If both A and B have such a chequebook contract, each having some collateral locked up for the other, then this setup is of functionally equivalent to a full payment channel; with the exception that states can not be `save on-chain' without an actual transfer. In a real payment channel the contract can update the relative balance - how much of the tied up collateral belongs to A and how much belongs to B - but in the chequebook implementation such a re-balancing necessarily involves a transfer from one chequebook contract to the other. Furthermore, advanced payment channels such as Raiden \cite{citation-needed:Raiden} have the ability to string together individual channels and compose them into a network.

Nevertheless, the chequebook implementation has the advantage that it can start out simple with features can being added gradually as they are needed.



% \textbf{Suggestion: delete the rest of this subsection}
% 
% 
% If the variance is expected to be higher than the loss a peer can afford,
% risk of insolvency can be mitigated by assigning part of the balance to a beneficiary.
% This locked up sum, called \gloss{channel deposit} allows the owner a tilted balance and
% serves as assured collateral dedicated to a particular peer.
% This can be implemented by keeping peer-specific balances in the chequebook contract.
% This deposit is no longer pooled over multiple creditors
% and locking it can guarantee successful cashing of cheques up to the deposited amount.
% Withdrawal from the channel deposit is possible but involves a grace period during which
% the counterparty is invited to challenge the current balance by sending in the (last) cheque
% with the highest amount. After the grace period the owner can reduce the deposit to cover only
% its actual debt and may withdraw the remainder.
% In order to get the balance of account between peers, the contract needs access to the counterparty
% chequebook contract. For ease of explanation we assume that beneficiary is the
% chequebook contract itself. Channel deposits can then be implemented as a map with beneficiary contract
% address as key and the integer balance in wei as value.
% 
% Two chequebook contracts that have a record for each other constitute what is
% called a \gloss{payment channel}.
% 
% 
% \begin{center}
% \begin{figure}
% \begin{center}
% \begin{tikzpicture}
%   \node (middle)[draw, rectangle, fill=green!60, minimum height=2em, minimum width=8em]{};
%   \node (midleft)[draw, rectangle, fill=orange!60, minimum height=2em, minimum width=4em, node distance=6em, left of=middle]{};
% \node (midright)[draw, rectangle, fill=orange!60, minimum height=2em, minimum width=4em, node distance=6em, right of=middle]{};
% \node (leftred) [draw, rectangle, fill=red!60, minimum height=2em, minimum width=2em, node distance=9em,left of=middle]{};
% \node (rightred)[draw, rectangle, fill=red!60, minimum height=2em, minimum width=2em, node distance=9em,right of=middle]{};
% \node (zero) [above of=middle,node distance=3.5em, text width=4em, align=center] {\small zero\\ balance};
% \node (zerod) [below of=middle] {};
% \draw [dashed](zero)--(zerod);
% \node (rtol) [node distance=8em,right of=zero,text width=4em, align=center] {\small payment\\threshold};
% \node (rtold) [node distance=8em,right of=zerod] {};
% \node (ltol) [node distance=8em,left of=zero,text width=4em, align=center] {\small payment\\threshold};
% \node (ltold) [node distance=8em,left of=zerod] {};
% \node (prtol) [node distance=4em,right of=zero,text width=4em, align=center] {\small channel\\deposit};
% \node (prtold) [node distance=4em,right of=zerod] {};
% \node (pltol) [node distance=4em,left of=zero,text width=4em, align=center] {\small channel\\deposit};
% \node (pltold) [node distance=4em,left of=zerod] {};
% \draw [dashed](rtol)--(rtold);
% \draw [dashed](ltol)--(ltold);
% \draw [dashed](prtol)--(prtold);
% \draw [dashed](pltol)--(pltold);
% \end{tikzpicture}
% \end{center}
% \caption{}
% \label{fig:paymentchannel}
% \end{figure}
% \end{center}

\subsection{Zero barrier to entry}

A tremendous advantage of swap accounting is that new users can begin to provide services and earn rewards without owning any ether initially.

Swap accounting can also work in one direction only. If a party enters the system with zero ether (\gloss{newcomer}), but connects to peers with funds (\gloss{insider}), the newcomer begins to provide the service (and not use it) in order to earn a positive swap balance. Once the payment threshold is reached, the newcomer will be paid and is then able to deploy chequebook of her own.
In short, even without any chequebook contract at all, Swap allows for zero cost onboarding of newcomers. Once the payout threshold is reached, the insiders could pays the newcomers on-chain. 

If the insider has a chequebook and wishes to pay the newcomer with a cheque, this is also possible, but there is a caveat here in that cashing cheques requires a gas expenditure\footnote{although this restriction may fall once ethereum is upgraded to the `Metropolis' release in which the chequebook contract will be able to pay for the transfer and deduct the cost of the transfer from the payout.}. The newcomer will be able to earn cheques for services provided, but will not have the means to cash them. 

This gas-cost bootstrapping problem is fundamental and cannot be circumvented without a direct on-chain payment. However it is surprising just how far we can get without it. It is possible for example to on-board newcomers to the point at which they have their own chequebook contract and are able to issue cheques as payments to third parties. That scheme would work as follows:
 
A newcomer connects to  an insider with an existing chequebook contract. The insider consumes the newcomers services and instead of issuing a cheque, the insider agrees to create a chequebook contract for the newcomer. In other words, when the insider's service debt reaches the amount needed for contract creation, the insider sends a transaction to create the contract with newcomer as the owner. Once the newcomer has her own chequebook contract, she is able to consume services and issue cheques to pay for them.
 
In order to be useful however, the deployed chequebook must also have some positive balance as collateral. Since the newcomer has no ether, it must be the insiders who deposit this starting balance. If peers agreed that they want to save on transaction costs, it is reasonable to create the contract with the required initial balance in one go. This would imply waiting out with contract creation until the insider's debt reaches the \emph{cost of bootstrapping} which is the sum of (1) the cost of contract creation, (2) the required starting balance, and (3) possibly some extra service fee to incentivise insiders to provide this kind of service.
% 
% With the global deposit included, this cost of bootstrapping can be substantially higher than the newcomers loss tolerance. If the newcomers chequebook is to be deployed only after newcomer provided service totalling the cost, then the insider node could disappear after essentially leeching on the newcomer. On the other hand, if it is deployed to the blockchain in advance, then it is the newcomer who can just disappera and move with their new topped-up wallet to other peers leaving the lender node with a loss. 
% 
% Luckily, there is a safe protocol to tackle bootstrapping: the newcomer issues a cheque to the insider in advance with an amount corresponding to the bootstrapping cost. The insider creates a chequebook contract with herself as owner and also includes locked collateral in the amount of the cheque, with herself set as the beneficiary. [At this point if the two peers disconnect, the newcomer suffered no loss, and the insider has a second chequebook contract that she can just offer to the next newcomer]. 
% 
% 
% The service goes exactly the way as if the newcomer was an insider with a contract, and the insider held a non-cashed cheque, i.e., as the insider consumes, each time it reaches the payment threshold, it issues a debt waiver - a new cheque with a lower total amount exactly as described in section \ref{subsubsec:waivingdebt}. 
% % 
% %
% % This is equivalent to the insider setting up a subscription with newcomer, authorising withdrawal with the waivers (see figure \ref{fig:bootstrapping}).
% % 
% % \begin{center}
% % \begin{figure}
% % \begin{center}
% % \end{center}
% % \caption{Bootstrapping or how to launch as a swap capable node consuming and providing a
% % service  and earn money}
% % \label{fig:bootstrapping}
% % \end{figure}
% % % \end{center}
% % 
% % 
% As newcomer provides service and insider consumes, it is business as usual, each new cheque reducing the cumulative total. Once the cumulative total reaches zero, the chequebook .... this all is a very convoluted system that doesnt help us at all because in the end we still have a gas cost issue.
% % Newcomer provides service to other peers and accepts payments sent to the
% % contract. If the inpayments are insufficient to get the balance up
% % to cover the bootstrapping cost, the entire contract is still owned by the insider
% % who can reuse it with another peer with previous inpayments counting as profit.
% % In this case neither the cheque nor the waivers are valid, therefore all the service insider
% % may have received was free.
% % 
% If the balance goes above the cost of bootstrapping, the insider can cash it with
% the original cheque which will automatically change the owner to newcomer.
% The cheque works exactly as normal, i.e., when cashed, it is stored in escrow
% while the contract receives waivers.
% Waivers can be used to first cover the difference between channel deposit and balance, and above that
% count to reduce the outpayment to insider. In normal operation, once waivers goes over
% the cost of bootstrapping, insider issues ???
% 
% This system is complete if newcomers have a way to send waivers to the contract.
% Since newcomers have zero balance, they cannot bear the transaction   cost and need others to send it for them. 
% Waivers and cheques can be signed by their beneficiary. These variants are also accepted by the chequebook
% and instruct the contract to pay an amount to the transaction sender covering the transaction cost plus a small service fee.  This way the prospect of the bounty serves as an incentive to
% third party insiders to transact on behalf of newcomers.
% The waiver or cheque triggers outpayment from the chequebook global  balance to the owner.
% This is how to earn ether with a service starting from nothing in the most efficient way.
% Signed notes are not only useful for newcomers; anyone without a blockchain connection
% will be able to interact and provide services without losing the security of the blockchain.
% 
%

To summarise, by serving before consuming, participants can bootstrap their way into swap without the need for funds. Hence swap is justified as (\emph{setting up a wallet as payment}).
